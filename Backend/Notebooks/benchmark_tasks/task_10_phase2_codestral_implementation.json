{
  "task_id": "benchmark-010-phase2-codestral",
  "description": "Implémenter CodestralClient pour AETHERFLOW 0.2 - Utiliser AETHERFLOW 0.1 (Claude Code + DeepSeek) pour construire Codestral",
  "steps": [
    {
      "id": "step_1",
      "description": "Créer le fichier codestral_client.py avec la structure de base de la classe CodestralClient qui hérite de BaseLLMClient. La classe doit avoir un __init__ qui initialise les paramètres API (api_key, api_url, model, timeout, max_retries) depuis settings.mistral_api_key, settings.mistral_api_url, settings.codestral_model, settings.timeout, settings.max_retries. Créer un client httpx.AsyncClient avec les headers appropriés pour l'API Mistral (Authorization: Bearer {api_key}, Content-Type: application/json).",
      "type": "code_generation",
      "complexity": 0.4,
      "estimated_tokens": 400,
      "dependencies": [],
      "validation_criteria": [
        "Classe CodestralClient hérite de BaseLLMClient",
        "__init__ initialise tous les paramètres depuis settings",
        "Client httpx.AsyncClient créé avec headers corrects",
        "Gestion d'erreur si api_key manquante (raise ValueError)"
      ],
      "context": {
        "language": "python",
        "framework": "httpx",
        "files": [
          "Backend/Prod/models/codestral_client.py",
          "Backend/Prod/models/deepseek_client.py",
          "Backend/Prod/models/base_client.py",
          "Backend/Prod/config/settings.py"
        ]
      }
    },
    {
      "id": "step_2",
      "description": "Implémenter les propriétés @property name() et specialties() pour CodestralClient. name doit retourner 'codestral'. specialties doit retourner une liste avec 'code_generation', 'local_editing', 'fim', 'refactoring'.",
      "type": "code_generation",
      "complexity": 0.2,
      "estimated_tokens": 200,
      "dependencies": ["step_1"],
      "validation_criteria": [
        "Propriété name retourne 'codestral'",
        "Propriété specialties retourne la liste correcte",
        "Utilise le décorateur @property"
      ],
      "context": {
        "language": "python",
        "files": [
          "Backend/Prod/models/codestral_client.py",
          "Backend/Prod/models/deepseek_client.py"
        ]
      }
    },
    {
      "id": "step_3",
      "description": "Implémenter la méthode async generate() pour CodestralClient. Cette méthode doit prendre prompt, context (optionnel), max_tokens (optionnel), temperature (optionnel) et retourner un GenerationResult. Construire le prompt complet en combinant context et prompt. Préparer la requête JSON avec model, messages (role: user, content: prompt), max_tokens, temperature. Utiliser le client httpx pour POST vers l'API Mistral (settings.mistral_api_url).",
      "type": "code_generation",
      "complexity": 0.6,
      "estimated_tokens": 600,
      "dependencies": ["step_1", "step_2"],
      "validation_criteria": [
        "Méthode generate() implémentée avec signature correcte",
        "Prompt construit correctement avec context",
        "Requête JSON formatée correctement",
        "Appel API POST vers Mistral",
        "Retourne GenerationResult"
      ],
      "context": {
        "language": "python",
        "framework": "httpx",
        "files": [
          "Backend/Prod/models/codestral_client.py",
          "Backend/Prod/models/deepseek_client.py",
          "Backend/Prod/models/base_client.py"
        ]
      }
    },
    {
      "id": "step_4",
      "description": "Ajouter la gestion d'erreurs et retry avec backoff exponentiel dans la méthode generate(). Gérer les erreurs HTTPStatusError (429 rate limit avec retry et attente, >=500 server errors avec retry, autres erreurs client sans retry) et RequestError (avec retry). Implémenter retry avec max_retries tentatives et attente exponentielle (2^attempt secondes). Logger les erreurs et tentatives avec loguru. Retourner GenerationResult avec success=False en cas d'échec final.",
      "type": "code_generation",
      "complexity": 0.7,
      "estimated_tokens": 800,
      "dependencies": ["step_3"],
      "validation_criteria": [
        "Gestion erreur 429 (rate limit) avec retry et attente",
        "Gestion erreur >=500 (server error) avec retry",
        "Gestion RequestError avec retry",
        "Backoff exponentiel implémenté (2^attempt)",
        "Logging des erreurs et tentatives",
        "Retourne GenerationResult avec success=False en cas d'échec"
      ],
      "context": {
        "language": "python",
        "framework": "httpx",
        "files": [
          "Backend/Prod/models/codestral_client.py",
          "Backend/Prod/models/deepseek_client.py"
        ]
      }
    },
    {
      "id": "step_5",
      "description": "Extraire les tokens et calculer les coûts dans generate(). Extraire input_tokens, output_tokens, total_tokens depuis la réponse API (usage.prompt_tokens, usage.completion_tokens, usage.total_tokens). Implémenter _calculate_cost() qui calcule le coût basé sur les tokens (utiliser settings.mistral_input_cost_per_1k et settings.mistral_output_cost_per_1k si disponibles, sinon utiliser des valeurs par défaut : 0.0003 pour input, 0.0003 pour output). Calculer execution_time_ms avec datetime.now() (différence entre start et end). Retourner GenerationResult avec tous les champs remplis (success, code, tokens_used, input_tokens, output_tokens, cost_usd, execution_time_ms, provider).",
      "type": "code_generation",
      "complexity": 0.5,
      "estimated_tokens": 500,
      "dependencies": ["step_3", "step_4"],
      "validation_criteria": [
        "Extraction correcte des tokens depuis la réponse API",
        "Méthode _calculate_cost() implémentée",
        "Calcul du coût basé sur input/output tokens",
        "Calcul execution_time_ms correct",
        "GenerationResult complet avec tous les champs"
      ],
      "context": {
        "language": "python",
        "files": [
          "Backend/Prod/models/codestral_client.py",
          "Backend/Prod/models/deepseek_client.py",
          "Backend/Prod/config/settings.py"
        ]
      }
    },
    {
      "id": "step_6",
      "description": "Ajouter la méthode async close() pour fermer le client httpx (await self.client.aclose()). Implémenter une méthode _build_simple_prompt() similaire à DeepSeekClient qui combine context et prompt de manière cohérente (si context existe, ajouter 'Context: {context}\\n\\n' avant le prompt, puis ajouter 'Task: {prompt}\\n\\nGenerate the complete code implementation.').",
      "type": "code_generation",
      "complexity": 0.3,
      "estimated_tokens": 300,
      "dependencies": ["step_5"],
      "validation_criteria": [
        "Méthode close() implémentée",
        "Méthode _build_simple_prompt() implémentée",
        "Format du prompt cohérent avec DeepSeekClient"
      ],
      "context": {
        "language": "python",
        "files": [
          "Backend/Prod/models/codestral_client.py",
          "Backend/Prod/models/deepseek_client.py"
        ]
      }
    },
    {
      "id": "step_7",
      "description": "Mettre à jour AgentRouter pour inclure CodestralClient. Dans _initialize_providers(), ajouter l'initialisation de CodestralClient (self._clients['codestral'] = CodestralClient()). Gérer les erreurs d'initialisation (si MISTRAL_API_KEY manquante, logger un warning mais ne pas faire échouer l'initialisation - utiliser try/except). Dans select_provider(), permettre la sélection de 'codestral' comme provider valide. Ajouter l'import : from .codestral_client import CodestralClient.",
      "type": "code_generation",
      "complexity": 0.4,
      "estimated_tokens": 400,
      "dependencies": ["step_6"],
      "validation_criteria": [
        "CodestralClient initialisé dans _initialize_providers()",
        "Gestion d'erreur si API key manquante (warning, pas d'échec)",
        "Provider 'codestral' disponible dans select_provider()",
        "Import de CodestralClient ajouté"
      ],
      "context": {
        "language": "python",
        "files": [
          "Backend/Prod/models/agent_router.py",
          "Backend/Prod/models/codestral_client.py"
        ]
      }
    },
    {
      "id": "step_8",
      "description": "Ajouter les configurations manquantes dans settings.py pour Mistral/Codestral. Ajouter mistral_input_cost_per_1k (défaut: 0.0003) et mistral_output_cost_per_1k (défaut: 0.0003) avec leurs alias MISTRAL_INPUT_COST_PER_1K et MISTRAL_OUTPUT_COST_PER_1K. Suivre le même pattern que deepseek_input_cost_per_1k et deepseek_output_cost_per_1k.",
      "type": "code_generation",
      "complexity": 0.3,
      "estimated_tokens": 300,
      "dependencies": ["step_5"],
      "validation_criteria": [
        "mistral_input_cost_per_1k ajouté dans settings.py",
        "mistral_output_cost_per_1k ajouté dans settings.py",
        "Alias corrects pour variables d'environnement",
        "Valeurs par défaut appropriées (0.0003)"
      ],
      "context": {
        "language": "python",
        "files": [
          "Backend/Prod/config/settings.py"
        ]
      }
    }
  ],
  "metadata": {
    "created_at": "2025-01-25T12:00:00Z",
    "claude_version": "claude-code",
    "project_context": "Benchmark méta : Utiliser AETHERFLOW 0.1 (Claude Code + DeepSeek) pour implémenter CodestralClient (AETHERFLOW 0.2 Phase 2.1)"
  }
}
