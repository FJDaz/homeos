<div id="studio-main-zone" class="p-8 max-w-7xl mx-auto animate-fade-in">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center gap-3 mb-2">
            <div class="w-10 h-10 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                </svg>
            </div>
            <h2 class="text-2xl font-bold text-slate-800">Analyse de votre design</h2>
        </div>
        <p class="text-slate-600 ml-13">
            Sullivan a analys√© votre image le <span class="font-medium">{{ report.metadata.analyzed_at }}</span>
            <span class="text-xs text-slate-400 ml-2">({{ report.metadata.model }})</span>
        </p>
    </div>

    <div class="grid lg:grid-cols-2 gap-8">
        <!-- Colonne gauche : PNG + Calque zones -->
        <div>
            <h3 class="text-lg font-semibold text-slate-800 mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                Zones d√©tect√©es
                <span class="text-sm font-normal text-slate-500">({{ report.layout.zones|length }} zones)</span>
            </h3>

            <div class="relative border-2 border-slate-200 rounded-xl overflow-hidden bg-slate-100 shadow-inner">
                <!-- Image PNG -->
                <img src="{{ png_url }}" alt="Design upload√©" class="w-full h-auto block" id="design-image">

                <!-- Calque SVG avec zones -->
                <svg class="absolute inset-0 w-full h-full" id="zones-overlay" preserveAspectRatio="none">
                    {% for zone in report.layout.zones %}
                    <g class="zone-group cursor-pointer hover:opacity-80 transition-opacity"
                       data-zone-id="{{ zone.id }}"
                       onclick="toggleZone('{{ zone.id }}')">
                        <rect
                            x="{{ zone.coordinates.x }}"
                            y="{{ zone.coordinates.y }}"
                            width="{{ zone.coordinates.w }}"
                            height="{{ zone.coordinates.h }}"
                            fill="rgba(99, 102, 241, 0.15)"
                            stroke="#6366f1"
                            stroke-width="2"
                            stroke-dasharray="5,5"
                            class="hover:fill-indigo-400/25 transition-all"
                        />
                        <!-- Label de zone -->
                        <foreignObject
                            x="{{ zone.coordinates.x }}"
                            y="{{ zone.coordinates.y - 30 }}"
                            width="{{ zone.coordinates.w }}"
                            height="30">
                            <div xmlns="http://www.w3.org/1999/xhtml" class="flex items-center">
                                <span class="bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded-t-lg shadow-sm truncate">
                                    {{ zone.hypothesis.label }}
                                    <span class="opacity-75 font-normal">({{ "%.0f"|format(zone.hypothesis.confidence * 100) }}%)</span>
                                </span>
                            </div>
                        </foreignObject>
                        <!-- Composants d√©tect√©s -->
                        {% if zone.components %}
                        <foreignObject
                            x="{{ zone.coordinates.x + 5 }}"
                            y="{{ zone.coordinates.y + 5 }}"
                            width="{{ zone.coordinates.w - 10 }}"
                            height="30">
                            <div xmlns="http://www.w3.org/1999/xhtml" class="flex flex-wrap gap-1">
                                {% for comp in zone.components %}
                                <span class="text-[10px] bg-white/90 text-indigo-700 px-1.5 py-0.5 rounded shadow-sm">{{ comp }}</span>
                                {% endfor %}
                            </div>
                        </foreignObject>
                        {% endif %}
                    </g>
                    {% endfor %}
                </svg>
            </div>

            <p class="text-sm text-slate-500 mt-3 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Cliquez sur une zone pour voir les d√©tails
            </p>

            <!-- Liste des zones d√©tect√©es -->
            <div class="mt-4 space-y-2">
                {% for zone in report.layout.zones %}
                <div class="p-3 bg-slate-50 rounded-lg border border-slate-200 hover:border-indigo-300 transition-colors cursor-pointer"
                     onclick="highlightZone('{{ zone.id }}')"
                     id="zone-card-{{ zone.id }}">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 bg-indigo-500 rounded-full"></span>
                            <span class="font-medium text-slate-800">{{ zone.hypothesis.label }}</span>
                        </div>
                        <span class="text-xs text-slate-500">{{ zone.type }}</span>
                    </div>
                    <div class="mt-1 text-xs text-slate-500 ml-4">
                        Position: ({{ zone.coordinates.x }}, {{ zone.coordinates.y }}) 
                        ‚Ä¢ Taille: {{ zone.coordinates.w }}√ó{{ zone.coordinates.h }}px
                        ‚Ä¢ Confiance: {{ "%.0f"|format(zone.hypothesis.confidence * 100) }}%
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Colonne droite : Style Guide -->
        <div>
            <h3 class="text-lg font-semibold text-slate-800 mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
                </svg>
                Style Guide extrait
            </h3>

            <!-- Couleurs -->
            <div class="mb-6 bg-white rounded-xl border border-slate-200 p-5">
                <h4 class="font-medium text-slate-700 mb-3 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
                    </svg>
                    Palette de couleurs
                </h4>
                <div class="flex flex-wrap gap-4">
                    {% for name, color in report.style.colors.items() %}
                    {% if color %}
                    <div class="text-center group cursor-pointer" onclick="copyToClipboard('{{ color }}')">
                        <div class="relative">
                            <div
                                class="w-16 h-16 rounded-xl border-2 border-slate-200 shadow-sm group-hover:scale-105 transition-transform"
                                style="background-color: {{ color }};"
                            ></div>
                            <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <span class="bg-black/50 text-white text-xs px-2 py-1 rounded">Copier</span>
                            </div>
                        </div>
                        <span class="text-xs text-slate-600 mt-2 block capitalize">{{ name }}</span>
                        <code class="text-xs text-slate-500 font-mono bg-slate-100 px-1.5 py-0.5 rounded mt-1 block">{{ color }}</code>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>

            <!-- Typographie -->
            <div class="mb-6 bg-white rounded-xl border border-slate-200 p-5">
                <h4 class="font-medium text-slate-700 mb-3 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"/>
                    </svg>
                    Typographie
                </h4>
                <div class="space-y-3">
                    <div class="flex items-center justify-between py-2 border-b border-slate-100">
                        <span class="text-sm text-slate-600">Famille</span>
                        <code class="text-sm bg-slate-100 px-2 py-1 rounded font-mono">{{ report.style.typography.family }}</code>
                    </div>
                    {% if report.style.typography.weights %}
                    <div class="flex items-center justify-between py-2 border-b border-slate-100">
                        <span class="text-sm text-slate-600">Graisses</span>
                        <div class="flex gap-1">
                            {% for weight in report.style.typography.weights %}
                            <span class="text-xs bg-slate-100 px-2 py-1 rounded">{{ weight }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Tailles de police -->
                <div class="mt-4 space-y-2">
                    <p class="text-xs text-slate-500 uppercase tracking-wide">Tailles</p>
                    {% for size, value in report.style.typography.sizes.items() %}
                    <div class="flex items-center gap-3">
                        <span class="text-xs text-slate-500 w-12">{{ size }}</span>
                        <span style="font-size: {{ value }}; font-family: {{ report.style.typography.family }};" class="text-slate-800">
                            Aa
                        </span>
                        <code class="text-xs text-slate-400 font-mono">{{ value }}</code>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Spacing -->
            <div class="mb-6 bg-white rounded-xl border border-slate-200 p-5">
                <h4 class="font-medium text-slate-700 mb-3 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
                    </svg>
                    Espacements
                </h4>
                <div class="space-y-2 text-sm">
                    <div class="flex items-center justify-between py-1.5">
                        <span class="text-slate-600">Border radius</span>
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 border-2 border-slate-300 bg-slate-100" style="border-radius: {{ report.style.spacing.border_radius }}"></div>
                            <code class="bg-slate-100 px-2 py-1 rounded">{{ report.style.spacing.border_radius }}</code>
                        </div>
                    </div>
                    <div class="flex items-center justify-between py-1.5 border-t border-slate-100">
                        <span class="text-slate-600">Padding small</span>
                        <code class="bg-slate-100 px-2 py-1 rounded">{{ report.style.spacing.padding_sm }}</code>
                    </div>
                    <div class="flex items-center justify-between py-1.5 border-t border-slate-100">
                        <span class="text-slate-600">Padding base</span>
                        <code class="bg-slate-100 px-2 py-1 rounded">{{ report.style.spacing.padding_base }}</code>
                    </div>
                    <div class="flex items-center justify-between py-1.5 border-t border-slate-100">
                        <span class="text-slate-600">Padding large</span>
                        <code class="bg-slate-100 px-2 py-1 rounded">{{ report.style.spacing.padding_lg }}</code>
                    </div>
                    <div class="flex items-center justify-between py-1.5 border-t border-slate-100">
                        <span class="text-slate-600">Gap</span>
                        <code class="bg-slate-100 px-2 py-1 rounded">{{ report.style.spacing.gap }}</code>
                    </div>
                </div>
            </div>

            <!-- Layout info -->
            <div class="mb-6 bg-white rounded-xl border border-slate-200 p-5">
                <h4 class="font-medium text-slate-700 mb-3">Type de layout</h4>
                <div class="flex items-center gap-3">
                    <span class="text-2xl">üìê</span>
                    <div>
                        <p class="font-medium text-slate-800 capitalize">{{ report.layout.type }}</p>
                        <p class="text-sm text-slate-500">{{ report.layout.zones|length }} zones identifi√©es</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="mt-10 flex flex-col sm:flex-row items-center justify-between gap-4 pt-6 border-t border-slate-200">
        <button hx-get="/studio/step/5" 
                hx-target="#studio-main-zone"
                class="text-slate-500 hover:text-slate-700 text-sm font-medium inline-flex items-center gap-1 transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            Retour √† l'upload
        </button>

        <div class="flex items-center gap-3">
            <button hx-post="/studio/step/6/regenerate"
                    hx-target="#studio-main-zone"
                    hx-indicator="#regen-loading"
                    class="text-indigo-600 hover:text-indigo-700 text-sm font-medium px-4 py-2 rounded-lg hover:bg-indigo-50 transition-colors">
                üîÑ R√©g√©n√©rer l'analyse
            </button>
            
            <button hx-get="/studio/step/7/dialogue"
                    hx-target="#studio-main-zone"
                    class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-medium hover:bg-indigo-700 transition-colors inline-flex items-center gap-2 shadow-lg shadow-indigo-200">
                Continuer vers le Dialogue
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Loading indicator -->
    <div id="regen-loading" class="htmx-indicator fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 text-center shadow-2xl">
            <div class="animate-spin w-12 h-12 border-4 border-indigo-200 border-t-indigo-600 rounded-full mx-auto mb-4"></div>
            <p class="font-medium text-slate-800">Analyse en cours...</p>
            <p class="text-sm text-slate-500">Gemini Vision examine votre design</p>
        </div>
    </div>
</div>

<script>
function toggleZone(zoneId) {
    // Toggle highlight on zone card
    const card = document.getElementById('zone-card-' + zoneId);
    if (card) {
        card.classList.toggle('ring-2');
        card.classList.toggle('ring-indigo-500');
        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}

function highlightZone(zoneId) {
    // Highlight zone in SVG
    const zoneGroup = document.querySelector(`[data-zone-id="${zoneId}"]`);
    if (zoneGroup) {
        const rect = zoneGroup.querySelector('rect');
        rect.style.fill = 'rgba(99, 102, 241, 0.4)';
        setTimeout(() => {
            rect.style.fill = 'rgba(99, 102, 241, 0.15)';
        }, 1000);
    }
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        // Could add a toast notification here
        console.log('Copied:', text);
    });
}
</script>
