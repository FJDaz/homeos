
@font-face {
    font-family: 'Wingdings3';
    src: url('/fonts/Wingdings3.woff2') format('woff2'),
         url('/fonts/Wingdings3.woff') format('woff');
    font-weight: normal;
    font-style: normal;
    font-display: swap;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; overflow: hidden; background: #f8fafc; }

/* Wingdings arrows */
.wingding-arrow {
    font-family: 'Wingdings3', sans-serif;
    font-size: 14px;
    display: inline-block;
    transition: transform 0.2s;
}
.wingding-arrow.collapsed {
    transform: rotate(-90deg);
}

/* Tabs */
.tabs { 
    display: flex; 
    height: 52px; 
    background: #fff; 
    border-bottom: 1px solid #e2e8f0; 
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    position: sticky;
    top: 0;
    z-index: 100;
}
.tab { 
    flex: 1; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    cursor: pointer; 
    font-size: 14px; 
    color: #64748b; 
    border-right: 1px solid #f1f5f9; 
    transition: all 0.2s; 
    font-weight: 500; 
}
.tab:last-child { border-right: none; }
.tab:hover { background: linear-gradient(180deg, #fff 0%, #f8fafc 100%); color: #334155; }
.tab.active { 
    background: transparent; 
    color: #1e293b; 
    font-weight: 700; 
    border-bottom: 3px solid #7aca6a; 
}

/* Main Layout */
.main { display: flex; height: calc(100vh - 52px); }

/* Sidebar */
.sidebar { 
    width: 280px; 
    background: linear-gradient(180deg, #fff 0%, #fafafa 100%); 
    border-right: 1px solid #e2e8f0; 
    overflow-y: auto; 
    flex-shrink: 0;
}
.sidebar-header { padding: 20px; border-bottom: 1px solid #e2e8f0; }
.sidebar-title { font-size: 22px; font-weight: 800; color: #7aca6a; }
.K { color: #000; font-weight: 500; }
.sidebar-subtitle { font-size: 12px; color: #94a3b8; margin-top: 4px; }
.sidebar-section { padding: 18px; border-bottom: 1px solid #f1f5f9; }
.sidebar-label { 
    font-size: 12px; 
    font-weight: 700; 
    color: #94a3b8; 
    text-transform: uppercase; 
    letter-spacing: 0.8px; 
    margin-bottom: 14px; 
}

/* Content */
.content { 
    flex: 1; 
    overflow-y: auto; 
    padding: 24px; 
    background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
}
.container { max-width: 1400px; margin: 0 auto; }

h1 { font-size: 24px; font-weight: 800; color: #1e293b; margin-bottom: 8px; }
.subtitle { font-size: 14px; color: #64748b; margin-bottom: 24px; }

/* Collapsible Section */
.section { 
    margin-bottom: 20px; 
    background: white;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    overflow: hidden;
}

.section-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px 20px;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    cursor: pointer;
    transition: all 0.2s;
    user-select: none;
}
.section-header:hover {
    background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
}

.section-title { 
    font-size: 14px; 
    font-weight: 700; 
    color: #1e293b;
    display: flex;
    align-items: center;
    gap: 8px;
}
.section-count {
    font-size: 12px;
    color: #64748b;
    font-weight: 500;
    background: white;
    padding: 2px 10px;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
}
.section-desc {
    font-size: 12px;
    color: #64748b;
    margin-left: auto;
    font-style: italic;
}

.section-content {
    padding: 20px;
    transition: all 0.3s ease;
}
.section-content.collapsed {
    display: none;
}

.row { 
    display: flex; 
    gap: 16px; 
    flex-wrap: wrap;
}

.comp-card {
    width: calc(20% - 13px);
    min-width: 180px;
    max-width: 240px;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
.comp-card:hover { 
    box-shadow: 0 8px 24px rgba(0,0,0,0.12); 
    transform: translateY(-4px);
    border-color: #7aca6a;
}
.comp-card.selected { 
    border-color: #7aca6a; 
    box-shadow: 0 0 0 3px rgba(122,202,106,0.2); 
}
.comp-card.hidden { display: none; }

.comp-info { padding: 12px 14px; border-bottom: 1px solid #f1f5f9; min-height: 70px; }
.comp-name { 
    font-size: 13px; 
    font-weight: 700; 
    color: #1e293b; 
    white-space: nowrap; 
    overflow: hidden; 
    text-overflow: ellipsis; 
    margin-bottom: 4px; 
}
.comp-endpoint { 
    font-size: 10px; 
    color: #94a3b8; 
    font-family: 'SF Mono', Monaco, monospace; 
    white-space: nowrap; 
    overflow: hidden; 
    text-overflow: ellipsis; 
}

.comp-footer { 
    display: flex; 
    align-items: center; 
    justify-content: space-between;
    padding: 10px 14px; 
    background: #fafafa;
}
.comp-method { 
    font-size: 10px; 
    font-weight: 700; 
    text-transform: uppercase;
    padding: 3px 10px; 
    border-radius: 4px;
}
.comp-checkbox { 
    width: 18px; 
    height: 18px; 
    accent-color: #7aca6a; 
    cursor: pointer;
}

.sticky-header {
    position: sticky;
    top: -24px;
    background: linear-gradient(180deg, rgba(248,250,252,0.98) 0%, rgba(241,245,249,0.98) 100%);
    padding: 16px 0;
    margin-bottom: 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #e2e8f0;
    z-index: 50;
}
.validate-btn {
    padding: 10px 24px;
    background: linear-gradient(145deg, #7aca6a 0%, #6aba5a 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    opacity: 0.5;
    transition: all 0.2s;
}
.validate-btn:enabled { 
    opacity: 1;
}
.validate-btn:enabled:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(122,202,106,0.4);
}

.stat-box {
    text-align: center;
    padding: 14px;
    background: linear-gradient(145deg, #fff 0%, #f8fafc 100%);
    border-radius: 10px;
    border: 1px solid #e2e8f0;
    transition: all 0.2s;
}
.stat-box:hover {
    border-color: #7aca6a;
    transform: translateY(-2px);
}
.stat-number {
    font-size: 24px;
    font-weight: 800;
    color: #7aca6a;
}
.stat-label {
    font-size: 11px;
    color: #94a3b8;
    font-weight: 600;
    text-transform: uppercase;
    margin-top: 4px;
}

/* Style Choice Section */
.style-option-card {
    width: 450px;
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 16px;
    padding: 24px;
    transition: all 0.3s;
}
.style-option-card:hover {
    border-color: #7aca6a;
    box-shadow: 0 8px 24px rgba(122,202,106,0.15);
}
.style-option-header {
    font-size: 18px;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 20px;
    text-align: center;
}
.upload-zone {
    border: 2px dashed #cbd5e1;
    border-radius: 12px;
    padding: 40px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
}
.upload-zone:hover {
    border-color: #7aca6a;
    background: #f0fdf4;
}
.styles-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
}
.style-card {
    height: 90px;
    background: #f8fafc;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    overflow: hidden;
    padding: 0;
}
.style-card:hover {
    border-color: #7aca6a;
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.style-card.selected {
    border-color: #7aca6a;
    box-shadow: 0 0 0 3px rgba(122,202,106,0.3);
}

/* Style Previews - Classy & Elegant */
.style-preview {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 10px;
}
.style-preview .sp-title {
    font-size: 11px;
    font-weight: 600;
    margin-bottom: 3px;
    letter-spacing: 0.3px;
}
.style-preview .sp-sub {
    font-size: 8px;
    font-weight: 400;
    opacity: 0.7;
    letter-spacing: 0.5px;
    text-transform: uppercase;
}

/* Minimal: Refined simplicity */
.minimal-preview {
    background: #fafafa;
    color: #525252;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
}
.minimal-preview .sp-title { 
    font-weight: 400; 
    letter-spacing: 1px;
    text-transform: uppercase;
    font-size: 10px;
}

/* Corporate: Executive elegance */
.corporate-preview {
    background: #f8fafc;
    color: #1e3a5f;
    font-family: 'Times New Roman', Times, serif;
}
.corporate-preview .sp-title { 
    font-weight: 600; 
    letter-spacing: 0.5px; 
    font-size: 12px;
}

/* Creative: Artistic sophistication */
.creative-preview {
    background: #fef7ed;
    color: #9a3412;
    font-family: Georgia, 'Palatino', serif;
}
.creative-preview .sp-title { 
    font-weight: 500; 
    font-style: italic;
    letter-spacing: 0.5px;
}

/* Tech: Precision engineering */
.tech-preview {
    background: #f1f5f9;
    color: #334155;
    font-family: 'SF Mono', 'Monaco', monospace;
}
.tech-preview .sp-title { 
    font-weight: 500; 
    letter-spacing: 1px;
    font-size: 10px;
}

/* Elegant: Timeless luxury */
.elegant-preview {
    background: #fffbeb;
    color: #713f12;
    font-family: 'Times New Roman', serif;
}
.elegant-preview .sp-title { 
    font-weight: 400; 
    letter-spacing: 1.5px;
    text-transform: uppercase;
    font-size: 10px;
}

/* Playful: Approachable warmth */
.playful-preview {
    background: #fdf4ff;
    color: #7c3aed;
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
}
.playful-preview .sp-title { 
    font-weight: 500; 
    letter-spacing: 0.5px;
}

/* Dark: Understated sophistication */
.dark-preview {
    background: #27272a;
    color: #d4d4d8;
    font-family: -apple-system, sans-serif;
}
.dark-preview .sp-title { 
    font-weight: 400; 
    letter-spacing: 1px;
    text-transform: uppercase;
    font-size: 10px;
}

/* Colorful: Curated harmony */
.colorful-preview {
    background: linear-gradient(135deg, #ddd6fe 0%, #fce7f3 50%, #fed7aa 100%);
    color: #581c87;
    font-family: -apple-system, sans-serif;
}
.colorful-preview .sp-title { 
    font-weight: 600;
    letter-spacing: 0.5px;
}

/* Section header emoji removal */
.section-title { font-size: 14px; font-weight: 700; }
.style-option-header { font-size: 18px; font-weight: 700; color: #1e293b; margin-bottom: 20px; text-align: center; }
.btn-secondary {
    margin-top: 12px;
    padding: 8px 24px;
    background: #f1f5f9;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    color: #475569;
    cursor: pointer;
    transition: all 0.2s;
}
.btn-secondary:hover {
    background: #e2e8f0;
}

@media (max-width: 1400px) { 
    .comp-card { width: calc(25% - 12px); } 
}
@media (max-width: 1100px) { 
    .comp-card { width: calc(33.333% - 11px); } 
}
@media (max-width: 900px) { 
    .comp-card { width: calc(50% - 8px); } 
}

/* ========================================
   STENCILER SECTION (extension)
   ======================================== */

#stenciler-section {
    display: block;
    position: sticky;
    top: 0;
    z-index: 100;
    background: #fff;
    border-bottom: 1px solid #e2e8f0;
}

#stenciler-section.visible {
    display: block;
}

/* Bande de previews */
.previews-band {
    display: flex;
    gap: 16px;
    justify-content: center;
    padding: 20px;
    background: #f8fafc;
    border-radius: 12px;
    margin-bottom: 24px;
}

.preview-corps {
    width: 120px;
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    cursor: grab;
    transition: all 0.2s;
}

.preview-corps:hover {
    border-color: #7aca6a;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.preview-corps.dragging {
    opacity: 0.5;
    cursor: grabbing;
}

.preview-header {
    padding: 8px;
    color: white;
    font-size: 11px;
    font-weight: 700;
    text-align: center;
    border-radius: 6px 6px 0 0;
}

.preview-body {
    padding: 8px;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.preview-organe {
    padding: 4px 6px;
    background: #f1f5f9;
    border-radius: 4px;
    font-size: 9px;
    color: #64748b;
}

/* Layout Sidebar + Canvas */
.stenciler-layout {
    display: flex;
    gap: 16px;
    height: 600px;
}

.stenciler-sidebar {
    width: 200px;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 16px;
    flex-shrink: 0;
}

.stenciler-canvas {
    flex: 1;
    background: white;
    border: 2px dashed #cbd5e1;
    border-radius: 12px;
    position: relative;
    overflow: hidden;
}

.stenciler-canvas.drag-over {
    border-color: #7aca6a;
    background: #f0fdf4;
}

#tarmac-canvas {
    width: 100%;
    height: 100%;
}

.sidebar-header {
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 1px solid #e2e8f0;
}

.sidebar-header h3 {
    font-size: 14px;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 4px;
}

#selection-info {
    font-size: 11px;
    color: #64748b;
}

.tool-section {
    margin-bottom: 20px;
}

.tool-label {
    font-size: 11px;
    font-weight: 600;
    color: #64748b;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.color-swatches {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}

.color-swatch {
    width: 24px;
    height: 24px;
    border-radius: 6px;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.2s;
}

.color-swatch:hover,
.color-swatch.active {
    border-color: #1f2937;
    transform: scale(1.1);
}

.slider-container {
    display: flex;
    align-items: center;
    gap: 8px;
}

.slider-container input[type="range"] {
    flex: 1;
    height: 6px;
    border-radius: 3px;
    background: #e2e8f0;
    outline: none;
    -webkit-appearance: none;
}

.slider-container input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #3b82f6;
    cursor: pointer;
    border: 2px solid white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.slider-value {
    font-size: 11px;
    color: #64748b;
    min-width: 35px;
    text-align: right;
}

.btn-delete {
    width: 100%;
    padding: 10px;
    background: #fee2e2;
    color: #dc2626;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s;
}

.btn-delete:hover {
    background: #fecaca;
}


// ============================================
// CONSTITUTION AETHERFLOW - SYST√àME DE RENDU
// ============================================
// Ce fichier fait partie du Syst√®me de Rendu (Frontend)
// R√¥le : Manipulation DOM, √©v√©nements, interactions utilisateur
// Interdits : Logique m√©tier, persistance, validation backend
// Conformit√© : Article 5 - Territoire du Syst√®me de Rendu
// ============================================

// V√©rification de conformit√© constitutionnelle
function checkConstitutionalCompliance() {
    const violations = [];
    
    // Article 5.2 - Le Syst√®me de Rendu ne manipule JAMAIS :
    const forbiddenPatterns = [
        /GenomeStateManager/i,
        /ModificationLog/i,
        /apply_modification/i,
        /validate_property/i,
        /event sourcing/i,
        /persistance/i,
        /coherence/i,
        /rules m√©tier/i,
        /r√®gles m√©tier/i
    ];
    
    // Analyse du code source
    const code = checkConstitutionalCompliance.toString() + 
                 switchTab.toString() + 
                 toggleSection.toString() +
                 updateValidateButton.toString();
    
    forbiddenPatterns.forEach(pattern => {
        if (pattern.test(code)) {
            violations.push(`Violation Article 5.2: ${pattern}`);
        }
    });
    
    if (violations.length > 0) {
        console.error('‚ùå VIOLATION CONSTITUTIONNELLE D√âTECT√âE');
        violations.forEach(v => console.error(v));
        throw new Error('Code non conforme √† la Constitution AETHERFLOW');
    }
    
    console.log('‚úÖ Code conforme √† la Constitution AETHERFLOW');
    console.log('   - R√¥le: Syst√®me de Rendu (Frontend)');
    console.log('   - Territoire: HTML, CSS, Layout, Interactions');
    console.log('   - Interdits respect√©s: Aucune logique m√©tier');
    return true;
}

// Ex√©cuter la v√©rification au chargement
document.addEventListener('DOMContentLoaded', () => {
    try {
        checkConstitutionalCompliance();
    } catch (error) {
        console.error('ARR√äT IMM√âDIAT - Constitution viol√©e:', error.message);
        // En production, on pourrait afficher un message √† l'utilisateur
        alert('Erreur de conformit√© syst√®me. Veuillez recharger la page.');
    }
});

// Mapping des tabs vers les corps (version d√©coupl√©e)
const tabMapping = {
    'all': 'all',
    'brs': 'brainstorm',
    'bkd': 'backend',
    'frd': 'frontend',
    'dpl': 'deploy'
};

function switchTab(element, tab) {
    // V√©rification pr√©alable - Article 13.1
    if (typeof tab !== 'string' || !tabMapping[tab]) {
        console.warn('‚ö†Ô∏è Param√®tre tab invalide - Ignor√©');
        return;
    }
    
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    element.classList.add('active');
    
    const corpsFilter = tabMapping[tab];
    const cards = document.querySelectorAll('.comp-card');
    
    cards.forEach(card => {
        // Utilisation d'attributs data- pour le filtrage visuel uniquement
        // Pas d'interpr√©tation s√©mantique du contenu
        if (corpsFilter === 'all' || card.dataset.corps === corpsFilter) {
            card.classList.remove('hidden');
        } else {
            card.classList.add('hidden');
        }
    });
    
    updateValidateButton();
}

function toggleSection(header) {
    const arrow = header.querySelector('.wingding-arrow');
    const content = header.nextElementSibling;
    
    arrow.classList.toggle('collapsed');
    content.classList.toggle('collapsed');
}

function toggleAll(source) {
    const visibleCards = document.querySelectorAll('.comp-card:not(.hidden)');
    visibleCards.forEach(card => {
        const checkbox = card.querySelector('.comp-checkbox');
        if (checkbox) checkbox.checked = source.checked;
    });
    updateValidateButton();
}

function updateValidateButton() {
    const count = document.querySelectorAll('.comp-checkbox:checked').length;
    const btn = document.getElementById('validate-btn');
    if (btn) {
        btn.innerHTML = 'Valider (' + count + ')';
        btn.disabled = count === 0;
    }
}

function toggleCheckbox(id) {
    const cb = document.getElementById(id);
    if (cb) {
        cb.checked = !cb.checked;
        updateValidateButton();
    }
}

// Fonction de scroll vers le choix de style
function scrollToStyleChoice() {
    const styleSection = document.getElementById('section-style-choice');
    if (styleSection) {
        // Afficher la section
        styleSection.style.display = 'block';
        
        // Scroll smooth vers la section
        setTimeout(() => {
            styleSection.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }, 100);
    }
}

// Gestion upload de fichier
document.addEventListener('DOMContentLoaded', () => {
    const uploadZone = document.getElementById('upload-zone');
    const fileInput = document.getElementById('file-input');
    
    if (uploadZone && fileInput) {
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.style.borderColor = '#7aca6a';
            uploadZone.style.background = '#f0fdf4';
        });
        
        uploadZone.addEventListener('dragleave', () => {
            uploadZone.style.borderColor = '#cbd5e1';
            uploadZone.style.background = 'transparent';
        });
        
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });
    }
    
    // Gestion s√©lection de style ‚Üí Sauvegarde + Redirect vers /stenciler
    document.querySelectorAll('.style-card').forEach(card => {
        card.addEventListener('click', () => {
            // D√©s√©lectionner les autres
            document.querySelectorAll('.style-card').forEach(c => c.classList.remove('selected'));
            // S√©lectionner celui-ci
            card.classList.add('selected');
            
            const selectedStyle = card.dataset.style;
            console.log('Style s√©lectionn√©:', selectedStyle);
            
            // Sauvegarder dans localStorage pour /stenciler
            // Note: Le genome sera fetch√© via /api/genome c√¥t√© serveur
            // Conformit√© Article 6 - Communication via API REST
            localStorage.setItem('aetherflow_selected_style', selectedStyle);
            localStorage.setItem('aetherflow_timestamp', Date.now().toString());
            
            console.log('üíæ Donn√©es sauvegard√©es, redirection vers /stenciler...');
            console.log('üì° Conformit√©: Communication frontend‚Üíbackend via redirection HTTP');
            
            // Redirection vers /stenciler
            window.location.href = '/stenciler';
        });
    });
    
    // Initialisation des statistiques (purement visuel)
    initializeStats();
});

function handleFileUpload(file) {
    console.log('Fichier upload√©:', file.name);
    // Note: L'analyse Gemini Vision serait impl√©ment√©e c√¥t√© backend
    // Conformit√©: Le frontend ne fait que transmettre le fichier
    alert(`Maquette "${file.name}" upload√©e !\nAnalyse Gemini Vision √† impl√©menter c√¥t√© backend...`);
}

// Fonction utilitaire pour l'initialisation des stats
function initializeStats() {
    // Cette fonction ne contient que de la logique d'affichage
    // Pas de calcul m√©tier, pas de validation
    const statBoxes = document.querySelectorAll('.stat-box');
    statBoxes.forEach(box => {
        box.addEventListener('click', () => {
            // Feedback visuel uniquement
            box.style.transform = 'scale(0.98)';
            setTimeout(() => {
                box.style.transform = '';
            }, 150);
        });
    });
}

// ============================================
// D√âCLARATION DE CONFORMIT√â CONSTITUTIONNELLE
// ============================================
/*
Je, KIMI (Syst√®me de Rendu), d√©clare que ce code :

1. RESPECTE la fronti√®re herm√©tique (Article 1)
2. N'impl√©mente AUCUNE logique m√©tier (Article 5.2)
3. N'acc√®de PAS directement au backend (Article 6)
4. Ne manipule QUE du DOM, CSS et √©v√©nements (Article 5.1)
5. Utilise localStorage UNIQUEMENT pour l'√©tat d'interface temporaire
6. Communique avec le backend via redirections HTTP/API

Engagement : ¬´ Je suis le moteur de rendu. Je re√ßois du JSON. Je rends du visuel. Point final. ¬ª

Date de v√©rification : ${new Date().toISOString()}
Hash de conformit√© : viewer_js_conforme_v1.0
*/

// ============================================
// CONSTITUTION AETHERFLOW - SYST√àME DE RENDU
// ============================================
// Ce fichier fait partie du Syst√®me de Rendu (Frontend)
// R√¥le : Manipulation DOM, √©v√©nements, interactions utilisateur
// Interdits : Logique m√©tier, persistance, validation backend
// Conformit√© : Article 5 - Territoire du Syst√®me de Rendu
// ============================================

// V√©rification de conformit√© constitutionnelle
function checkConstitutionalCompliance() {
    const violations = [];
    
    // Article 5.2 - Le Syst√®me de Rendu ne manipule JAMAIS :
    const forbiddenPatterns = [
        /GenomeStateManager/i,
        /ModificationLog/i,
        /apply_modification/i,
        /validate_property/i,
        /event sourcing/i,
        /persistance/i,
        /coherence/i,
        /rules m√©tier/i,
        /r√®gles m√©tier/i
    ];
    
    // Analyse du code source
    const code = checkConstitutionalCompliance.toString() + 
                 switchTab.toString() + 
                 toggleSection.toString() +
                 updateValidateButton.toString() +
                 toggleAll.toString() +
                 toggleCheckbox.toString() +
                 scrollToStyleChoice.toString() +
                 handleFileUpload.toString() +
                 initializeStats.toString();
    
    forbiddenPatterns.forEach(pattern => {
        if (pattern.test(code)) {
            violations.push(`Violation Article 5.2: ${pattern}`);
        }
    });
    
    if (violations.length > 0) {
        console.error('‚ùå VIOLATION CONSTITUTIONNELLE D√âTECT√âE');
        violations.forEach(v => console.error(v));
        throw new Error('Code non conforme √† la Constitution AETHERFLOW');
    }
    
    console.log('‚úÖ Code conforme √† la Constitution AETHERFLOW');
    console.log('   - R√¥le: Syst√®me de Rendu (Frontend)');
    console.log('   - Territoire: HTML, CSS, Layout, Interactions');
    console.log('   - Interdits respect√©s: Aucune logique m√©tier');
    return true;
}

// Mapping des tabs vers les corps (version d√©coupl√©e)
const tabMapping = {
    'all': 'all',
    'brs': 'brainstorm',
    'bkd': 'backend',
    'frd': 'frontend',
    'dpl': 'deploy'
};

function switchTab(element, tab) {
    // V√©rification pr√©alable - Article 13.1
    if (typeof tab !== 'string' || !tabMapping[tab]) {
        console.warn('‚ö†Ô∏è Param√®tre tab invalide - Ignor√©');
        return;
    }
    
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    element.classList.add('active');
    
    const corpsFilter = tabMapping[tab];
    const cards = document.querySelectorAll('.comp-card');
    
    cards.forEach(card => {
        // Utilisation d'attributs data- pour le filtrage visuel uniquement
        // Pas d'interpr√©tation s√©mantique du contenu
        if (corpsFilter === 'all' || card.dataset.corps === corpsFilter) {
            card.classList.remove('hidden');
        } else {
            card.classList.add('hidden');
        }
    });
    
    updateValidateButton();
}

function toggleSection(header) {
    const arrow = header.querySelector('.wingding-arrow');
    const content = header.nextElementSibling;
    
    arrow.classList.toggle('collapsed');
    content.classList.toggle('collapsed');
}

function toggleAll(source) {
    const visibleCards = document.querySelectorAll('.comp-card:not(.hidden)');
    visibleCards.forEach(card => {
        const checkbox = card.querySelector('.comp-checkbox');
        if (checkbox) checkbox.checked = source.checked;
    });
    updateValidateButton();
}

function updateValidateButton() {
    const count = document.querySelectorAll('.comp-checkbox:checked').length;
    const btn = document.getElementById('validate-btn');
    if (btn) {
        btn.innerHTML = 'Valider (' + count + ')';
        btn.disabled = count === 0;
    }
}

function toggleCheckbox(id) {
    const cb = document.getElementById(id);
    if (cb) {
        cb.checked = !cb.checked;
        updateValidateButton();
    }
}

// Fonction de scroll vers le choix de style
function scrollToStyleChoice() {
    const styleSection = document.getElementById('section-style-choice');
    if (styleSection) {
        // Afficher la section
        styleSection.style.display = 'block';
        
        // Scroll smooth vers la section
        setTimeout(() => {
            styleSection.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }, 100);
    }
}

function handleFileUpload(file) {
    console.log('Fichier upload√©:', file.name);
    // Note: L'analyse Gemini Vision serait impl√©ment√©e c√¥t√© backend
    // Conformit√©: Le frontend ne fait que transmettre le fichier
    alert(`Maquette "${file.name}" upload√©e !\nAnalyse Gemini Vision √† impl√©menter c√¥t√© backend...`);
}

// Fonction utilitaire pour l'initialisation des stats
function initializeStats() {
    // Cette fonction ne contient que de la logique d'affichage
    // Pas de calcul m√©tier, pas de validation
    const statBoxes = document.querySelectorAll('.stat-box');
    statBoxes.forEach(box => {
        box.addEventListener('click', () => {
            // Feedback visuel uniquement
            box.style.transform = 'scale(0.98)';
            setTimeout(() => {
                box.style.transform = '';
            }, 150);
        });
    });
}

// Initialisation au chargement du DOM
document.addEventListener('DOMContentLoaded', () => {
    try {
        // V√©rification constitutionnelle
        checkConstitutionalCompliance();
        
        // Initialisation des composants
        initializeStats();
        
        // Gestion upload de fichier
        const uploadZone = document.getElementById('upload-zone');
        const fileInput = document.getElementById('file-input');
        
        if (uploadZone && fileInput) {
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.style.borderColor = '#7aca6a';
                uploadZone.style.background = '#f0fdf4';
            });
            
            uploadZone.addEventListener('dragleave', () => {
                uploadZone.style.borderColor = '#cbd5e1';
                uploadZone.style.background = 'transparent';
            });
            
            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0]);
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0]);
                }
            });
        }
        
        // Gestion s√©lection de style ‚Üí Sauvegarde + Redirect vers /stenciler
        document.querySelectorAll('.style-card').forEach(card => {
            card.addEventListener('click', () => {
                // D√©s√©lectionner les autres
                document.querySelectorAll('.style-card').forEach(c => c.classList.remove('selected'));
                // S√©lectionner celui-ci
                card.classList.add('selected');
                
                const selectedStyle = card.dataset.style;
                console.log('Style s√©lectionn√©:', selectedStyle);
                
                // Sauvegarder dans localStorage pour /stenciler
                // Note: Le genome sera fetch√© via /api/genome c√¥t√© serveur
                // Conformit√© Article 6 - Communication via API REST
                localStorage.setItem('aetherflow_selected_style', selectedStyle);
                localStorage.setItem('aetherflow_timestamp', Date.now().toString());
                
                console.log('üíæ Donn√©es sauvegard√©es, redirection vers /stenciler...');
                console.log('üì° Conformit√©: Communication frontend‚Üíbackend via redirection HTTP');
                
                // Redirection vers /stenciler
                window.location.href = '/stenciler';
            });
        });
        
    } catch (error) {
        console.error('ARR√äT IMM√âDIAT - Constitution viol√©e:', error.message);
        // En production, on pourrait afficher un message √† l'utilisateur
        alert('Erreur de conformit√© syst√®me. Veuillez recharger la page.');
    }
});

// ============================================
// D√âCLARATION DE CONFORMIT√â CONSTITUTIONNELLE
// ============================================
/*
Je, KIMI (Syst√®me de Rendu), d√©clare que ce code :

1. RESPECTE la fronti√®re herm√©tique (Article 1)
2. N'impl√©mente AUCUNE logique m√©tier (Article 5.2)
3. N'acc√®de PAS directement au backend (Article 6)
4. Ne manipule QUE du DOM, CSS et √©v√©nements (Article 5.1)
5. Utilise localStorage UNIQUEMENT pour l'√©tat d'interface temporaire
6. Communique avec le backend via redirections HTTP/API

Engagement : ¬´ Je suis le moteur de rendu. Je re√ßois du JSON. Je rends du visuel. Point final. ¬ª

Date de v√©rification : ${new Date().toISOString()}
Hash de conformit√© : viewer_js_conforme_v2.0
*/