{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "AetherFlow Plan Schema",
  "description": "Schema for AetherFlow task execution plans generated by Claude Code",
  "type": "object",
  "required": ["task_id", "description", "steps", "metadata"],
  "properties": {
    "task_id": {
      "type": "string",
      "description": "Unique identifier for the task (alphanumeric with hyphens/underscores)",
      "pattern": "^[a-zA-Z0-9_-]+$"
    },
    "description": {
      "type": "string",
      "description": "Human-readable description of the main task"
    },
    "steps": {
      "type": "array",
      "description": "List of execution steps",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["id", "description", "type", "complexity", "estimated_tokens"],
        "properties": {
          "id": {
            "type": "string",
            "description": "Unique identifier for the step (e.g., 'step_1', 'step_2')",
            "pattern": "^step_[0-9]+$"
          },
          "description": {
            "type": "string",
            "description": "Detailed description of what this step should accomplish"
          },
          "type": {
            "type": "string",
            "enum": ["code_generation", "refactoring", "analysis", "patch"],
            "description": "Type of task: code_generation (new/replace), refactoring (output to .generated), analysis (analyze), patch (insert/replace fragment in existing file at marker/line)"
          },
          "complexity": {
            "type": "number",
            "minimum": 0.0,
            "maximum": 1.0,
            "description": "Complexity score from 0.0 (simple) to 1.0 (very complex). Used for routing decisions."
          },
          "estimated_tokens": {
            "type": "integer",
            "minimum": 100,
            "maximum": 8000,
            "description": "Estimated number of tokens needed for this step"
          },
          "dependencies": {
            "type": "array",
            "description": "List of step IDs that must complete before this step can execute",
            "items": {
              "type": "string",
              "pattern": "^step_[0-9]+$"
            },
            "default": []
          },
          "validation_criteria": {
            "type": "array",
            "description": "List of criteria to validate step completion",
            "items": {
              "type": "string"
            },
            "default": []
          },
          "context": {
            "type": "object",
            "description": "Additional context for the step (optional)",
            "properties": {
              "files": {
                "type": "array",
                "items": {
                  "type": "string"
                },
                "description": "List of file paths to read/modify and to apply step output to"
              },
              "input_files": {
                "type": "array",
                "items": {
                  "type": "string"
                },
                "description": "Read-only files to inject into the prompt (e.g. genome, PRD). Not used for apply."
              },
              "language": {
                "type": "string",
                "description": "Programming language (e.g., 'python', 'javascript', 'typescript')"
              },
              "framework": {
                "type": "string",
                "description": "Framework or library (e.g., 'fastapi', 'react', 'express')"
              },
              "patch": {
                "type": "object",
                "description": "Requis si type === 'patch'. Où insérer/remplacer le fragment dans le fichier cible.",
                "properties": {
                  "position": {
                    "type": "string",
                    "enum": ["after", "before", "replace"],
                    "description": "after = insérer après marker/ligne ; before = avant ; replace = remplacer section entre marker_start et marker_end"
                  },
                  "marker": {
                    "type": "string",
                    "description": "Chaîne à rechercher (première occurrence). Utilisé avec position after ou before."
                  },
                  "marker_start": {
                    "type": "string",
                    "description": "Début de section à remplacer (position replace)."
                  },
                  "marker_end": {
                    "type": "string",
                    "description": "Fin de section à remplacer (position replace)."
                  },
                  "line": {
                    "type": "integer",
                    "minimum": 1,
                    "description": "Numéro de ligne 1-based. Alternative à marker pour after/before."
                  },
                  "idempotent": {
                    "type": "boolean",
                    "description": "Si true, ne pas insérer si le fragment est déjà présent (évite doublon en re-run)."
                  }
                },
                "required": ["position"]
              }
            }
          }
        }
      }
    },
    "metadata": {
      "type": "object",
      "required": ["created_at", "claude_version"],
      "properties": {
        "created_at": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp when the plan was created"
        },
        "claude_version": {
          "type": "string",
          "description": "Version identifier for Claude Code (e.g., 'claude-code')"
        },
        "project_context": {
          "type": "string",
          "description": "Brief description of the project context (optional)"
        }
      }
    }
  }
}
